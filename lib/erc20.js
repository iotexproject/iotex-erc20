"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ERC20 = void 0;

var _bignumber = _interopRequireDefault(require("bignumber.js"));

var _ethereumjsAbi = _interopRequireDefault(require("ethereumjs-abi"));

var _abiToByte = require("iotex-antenna/lib/contract/abi-to-byte");

var _contract = require("iotex-antenna/lib/contract/contract");

var _address = require("iotex-antenna/lib/crypto/address");

var _abi = require("./abi");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class ERC20 {
  constructor() {
    _defineProperty(this, "address", void 0);

    _defineProperty(this, "contract", void 0);

    _defineProperty(this, "provider", void 0);

    _defineProperty(this, "methods", void 0);
  }

  static create(address, provider) {
    const erc20 = new ERC20();
    erc20.address = address;
    erc20.provider = provider;
    erc20.contract = new _contract.Contract(_abi.ABI, address, {
      provider: provider
    });
    const methods = {}; // @ts-ignore

    for (const fnName of Object.keys(erc20.contract.getABI())) {
      // @ts-ignore
      const fnAbi = erc20.contract.getABI()[fnName];

      if (fnAbi.type === "constructor") {
        continue;
      }

      const args = (0, _abiToByte.getArgTypes)(fnAbi);
      const header = (0, _abiToByte.getHeaderHash)(fnAbi, args); // @ts-ignore

      methods[header] = {
        name: fnName,
        inputsNames: args.map(i => {
          return `${i.name}`;
        }),
        inputsTypes: args.map(i => {
          return `${i.type}`;
        })
      };
    }

    erc20.methods = methods;
    return erc20;
  }

  async name(callerAddress) {
    const result = await this.readMethod("name", callerAddress);

    const data = _ethereumjsAbi.default.rawDecode(["string"], Buffer.from(result, "hex"));

    if (data.length > 0) {
      return data[0];
    }

    return "";
  }

  async symbol(callerAddress) {
    const result = await this.readMethod("symbol", callerAddress);

    const data = _ethereumjsAbi.default.rawDecode(["string"], Buffer.from(result, "hex"));

    if (data.length > 0) {
      return data[0];
    }

    return "";
  }

  async decimals(callerAddress) {
    const result = await this.readMethod("decimals", callerAddress);
    return new _bignumber.default(result, 16);
  }

  async totalSupply(callerAddress) {
    const result = await this.readMethod("totalSupply", callerAddress);
    return new _bignumber.default(result, 16);
  }

  async balanceOf(owner, callerAddress) {
    const result = await this.readMethod("balanceOf", callerAddress, owner);
    return new _bignumber.default(result, 16);
  }

  async transfer(to, value, account, gasPrice, gasLimit) {
    return this.executeMethod("transfer", account, gasPrice, gasLimit, "0", to, value.toFixed(0));
  }

  async allowance(owner, spender, account, gasPrice, gasLimit) {
    return this.executeMethod("allowance", account, gasPrice, gasLimit, "0", owner, spender);
  }

  async approve(spender, value, account, gasPrice, gasLimit) {
    return this.executeMethod("approve", account, gasPrice, gasLimit, "0", spender, value.toFixed(0));
  }

  async transferFrom(from, to, value, account, gasPrice, gasLimit) {
    return this.executeMethod("transferFrom", account, gasPrice, gasLimit, "0", from, to, value.toFixed(0));
  }

  async readMethod(method, callerAddress, // @ts-ignore
  // tslint:disable-next-line: typedef
  ...args) {
    const result = await this.provider.readContract({
      execution: this.contract.pureEncodeMethod("0", method, ...args),
      callerAddress: callerAddress
    });
    return result.data;
  }

  executeMethod(method, account, gasPrice, gasLimit, amount, // @ts-ignore
  // tslint:disable-next-line: typedef
  ...args) {
    return this.contract.methods[method](...args, {
      account: account,
      amount: amount,
      gasLimit: gasLimit,
      gasPrice: gasPrice
    });
  }

  decode(data) {
    if (data.length < 8) {
      throw new Error("input data error");
    }

    const methodKey = data.substr(0, 8);
    const method = this.methods[methodKey];

    if (!method) {
      throw new Error(`method ${methodKey} is not erc20 method`);
    }

    const params = _ethereumjsAbi.default.rawDecode(method.inputsTypes, Buffer.from(data.substring(8), "hex"));

    const values = {};

    for (let i = 0; i < method.inputsTypes.length; i++) {
      if (method.inputsTypes[i] === "address") {
        params[i] = (0, _address.fromBytes)(Buffer.from(params[i].toString(), "hex")).string();
      } // @ts-ignore


      values[method.inputsNames[i]] = params[i];
    }

    return {
      method: method.name,
      data: values
    };
  }

}

exports.ERC20 = ERC20;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9lcmMyMC50cyJdLCJuYW1lcyI6WyJFUkMyMCIsImNyZWF0ZSIsImFkZHJlc3MiLCJwcm92aWRlciIsImVyYzIwIiwiY29udHJhY3QiLCJDb250cmFjdCIsIkFCSSIsIm1ldGhvZHMiLCJmbk5hbWUiLCJPYmplY3QiLCJrZXlzIiwiZ2V0QUJJIiwiZm5BYmkiLCJ0eXBlIiwiYXJncyIsImhlYWRlciIsIm5hbWUiLCJpbnB1dHNOYW1lcyIsIm1hcCIsImkiLCJpbnB1dHNUeXBlcyIsImNhbGxlckFkZHJlc3MiLCJyZXN1bHQiLCJyZWFkTWV0aG9kIiwiZGF0YSIsImV0aGVyZXVtanMiLCJyYXdEZWNvZGUiLCJCdWZmZXIiLCJmcm9tIiwibGVuZ3RoIiwic3ltYm9sIiwiZGVjaW1hbHMiLCJCaWdOdW1iZXIiLCJ0b3RhbFN1cHBseSIsImJhbGFuY2VPZiIsIm93bmVyIiwidHJhbnNmZXIiLCJ0byIsInZhbHVlIiwiYWNjb3VudCIsImdhc1ByaWNlIiwiZ2FzTGltaXQiLCJleGVjdXRlTWV0aG9kIiwidG9GaXhlZCIsImFsbG93YW5jZSIsInNwZW5kZXIiLCJhcHByb3ZlIiwidHJhbnNmZXJGcm9tIiwibWV0aG9kIiwicmVhZENvbnRyYWN0IiwiZXhlY3V0aW9uIiwicHVyZUVuY29kZU1ldGhvZCIsImFtb3VudCIsImRlY29kZSIsIkVycm9yIiwibWV0aG9kS2V5Iiwic3Vic3RyIiwicGFyYW1zIiwic3Vic3RyaW5nIiwidmFsdWVzIiwidG9TdHJpbmciLCJzdHJpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFJQTs7QUFDQTs7QUFFQTs7Ozs7O0FBK0RPLE1BQU1BLEtBQU4sQ0FBOEI7QUFBQTtBQUFBOztBQUFBOztBQUFBOztBQUFBO0FBQUE7O0FBTW5DLFNBQWNDLE1BQWQsQ0FBcUJDLE9BQXJCLEVBQXNDQyxRQUF0QyxFQUFvRTtBQUNsRSxVQUFNQyxLQUFLLEdBQUcsSUFBSUosS0FBSixFQUFkO0FBQ0FJLElB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RUxRLE1BQUFBLElBQUksRUFBRW1DO0FBRkQsS0FBUDtBQUlEOztBQXROa0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQmlnTnVtYmVyIGZyb20gXCJiaWdudW1iZXIuanNcIjtcbmltcG9ydCBldGhlcmV1bWpzIGZyb20gXCJldGhlcmV1bWpzLWFiaVwiO1xuaW1wb3J0IHsgQWNjb3VudCB9IGZyb20gXCJpb3RleC1hbnRlbm5hL2xpYi9hY2NvdW50L2FjY291bnRcIjtcbmltcG9ydCB7XG4gIGdldEFyZ1R5cGVzLFxuICBnZXRIZWFkZXJIYXNoXG59IGZyb20gXCJpb3RleC1hbnRlbm5hL2xpYi9jb250cmFjdC9hYmktdG8tYnl0ZVwiO1xuaW1wb3J0IHsgQ29udHJhY3QgfSBmcm9tIFwiaW90ZXgtYW50ZW5uYS9saWIvY29udHJhY3QvY29udHJhY3RcIjtcbmltcG9ydCB7IGZyb21CeXRlcyB9IGZyb20gXCJpb3RleC1hbnRlbm5hL2xpYi9jcnlwdG8vYWRkcmVzc1wiO1xuaW1wb3J0IHsgSVJwY01ldGhvZCB9IGZyb20gXCJpb3RleC1hbnRlbm5hL2xpYi9ycGMtbWV0aG9kL3R5cGVzXCI7XG5pbXBvcnQgeyBBQkkgfSBmcm9tIFwiLi9hYmlcIjtcblxuZXhwb3J0IGludGVyZmFjZSBNZXRob2Qge1xuICBuYW1lOiBzdHJpbmc7XG4gIGlucHV0c05hbWVzOiBbc3RyaW5nXTtcbiAgaW5wdXRzVHlwZXM6IFtzdHJpbmddO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERlY29kZURhdGEge1xuICBtZXRob2Q6IHN0cmluZztcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1hbnlcbiAgZGF0YTogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJRVJDMjAge1xuICBhZGRyZXNzOiBzdHJpbmc7XG5cbiAgbmFtZShjYWxsZXJBZGRyZXNzOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz47XG5cbiAgc3ltYm9sKGNhbGxlckFkZHJlc3M6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPjtcblxuICBkZWNpbWFscyhjYWxsZXJBZGRyZXNzOiBzdHJpbmcpOiBQcm9taXNlPEJpZ051bWJlcj47XG5cbiAgdG90YWxTdXBwbHkoY2FsbGVyQWRkcmVzczogc3RyaW5nKTogUHJvbWlzZTxCaWdOdW1iZXI+O1xuXG4gIGJhbGFuY2VPZihvd25lcjogc3RyaW5nLCBjYWxsZXJBZGRyZXNzOiBzdHJpbmcpOiBQcm9taXNlPEJpZ051bWJlcj47XG5cbiAgdHJhbnNmZXIoXG4gICAgdG86IHN0cmluZyxcbiAgICB2YWx1ZTogQmlnTnVtYmVyLFxuICAgIGFjY291bnQ6IEFjY291bnQsXG4gICAgZ2FzUHJpY2U6IHN0cmluZyxcbiAgICBnYXNMaW1pdDogc3RyaW5nXG4gICk6IFByb21pc2U8c3RyaW5nPjtcblxuICBhbGxvd2FuY2UoXG4gICAgb3duZXI6IHN0cmluZyxcbiAgICBzcGVuZGVyOiBzdHJpbmcsXG4gICAgYWNjb3VudDogQWNjb3VudCxcbiAgICBnYXNQcmljZTogc3RyaW5nLFxuICAgIGdhc0xpbWl0OiBzdHJpbmdcbiAgKTogUHJvbWlzZTxzdHJpbmc+O1xuXG4gIGFwcHJvdmUoXG4gICAgc3BlbmRlcjogc3RyaW5nLFxuICAgIHZhbHVlOiBCaWdOdW1iZXIsXG4gICAgYWNjb3VudDogQWNjb3VudCxcbiAgICBnYXNQcmljZTogc3RyaW5nLFxuICAgIGdhc0xpbWl0OiBzdHJpbmdcbiAgKTogUHJvbWlzZTxzdHJpbmc+O1xuXG4gIHRyYW5zZmVyRnJvbShcbiAgICBmcm9tOiBzdHJpbmcsXG4gICAgdG86IHN0cmluZyxcbiAgICB2YWx1ZTogQmlnTnVtYmVyLFxuICAgIGFjY291bnQ6IEFjY291bnQsXG4gICAgZ2FzUHJpY2U6IHN0cmluZyxcbiAgICBnYXNMaW1pdDogc3RyaW5nXG4gICk6IFByb21pc2U8c3RyaW5nPjtcblxuICBkZWNvZGUoZGF0YTogc3RyaW5nKTogRGVjb2RlRGF0YTtcbn1cblxuZXhwb3J0IGNsYXNzIEVSQzIwIGltcGxlbWVudHMgSUVSQzIwIHtcbiAgcHVibGljIGFkZHJlc3M6IHN0cmluZztcbiAgcHJpdmF0ZSBjb250cmFjdDogQ29udHJhY3Q7XG4gIHB1YmxpYyBwcm92aWRlcjogSVJwY01ldGhvZDtcbiAgcHJpdmF0ZSBtZXRob2RzOiB7IFtrZXk6IHN0cmluZ106IE1ldGhvZCB9O1xuXG4gIHB1YmxpYyBzdGF0aWMgY3JlYXRlKGFkZHJlc3M6IHN0cmluZywgcHJvdmlkZXI6IElScGNNZXRob2QpOiBJRVJDMjAge1xuICAgIGNvbnN0IGVyYzIwID0gbmV3IEVSQzIwKCk7XG4gICAgZXJjMjAuYWRkcmVzcyA9IGFkZHJlc3M7XG4gICAgZXJjMjAucHJvdmlkZXIgPSBwcm92aWRlcjtcbiAgICBlcmMyMC5jb250cmFjdCA9IG5ldyBDb250cmFjdChBQkksIGFkZHJlc3MsIHtcbiAgICAgIHByb3ZpZGVyOiBwcm92aWRlclxuICAgIH0pO1xuXG4gICAgY29uc3QgbWV0aG9kcyA9IHt9O1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBmb3IgKGNvbnN0IGZuTmFtZSBvZiBPYmplY3Qua2V5cyhlcmMyMC5jb250cmFjdC5nZXRBQkkoKSkpIHtcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIGNvbnN0IGZuQWJpID0gZXJjMjAuY29udHJhY3QuZ2V0QUJJKClbZm5OYW1lXTtcbiAgICAgIGlmIChmbkFiaS50eXBlID09PSBcImNvbnN0cnVjdG9yXCIpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGFyZ3MgPSBnZXRBcmdUeXBlcyhmbkFiaSk7XG4gICAgICBjb25zdCBoZWFkZXIgPSBnZXRIZWFkZXJIYXNoKGZuQWJpLCBhcmdzKTtcblxuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgbWV0aG9kc1toZWFkZXJdID0ge1xuICAgICAgICBuYW1lOiBmbk5hbWUsXG4gICAgICAgIGlucHV0c05hbWVzOiBhcmdzLm1hcChpID0+IHtcbiAgICAgICAgICByZXR1cm4gYCR7aS5uYW1lfWA7XG4gICAgICAgIH0pLFxuICAgICAgICBpbnB1dHNUeXBlczogYXJncy5tYXAoaSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGAke2kudHlwZX1gO1xuICAgICAgICB9KVxuICAgICAgfTtcbiAgICB9XG4gICAgZXJjMjAubWV0aG9kcyA9IG1ldGhvZHM7XG5cbiAgICByZXR1cm4gZXJjMjA7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbmFtZShjYWxsZXJBZGRyZXNzOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVhZE1ldGhvZChcIm5hbWVcIiwgY2FsbGVyQWRkcmVzcyk7XG4gICAgY29uc3QgZGF0YSA9IGV0aGVyZXVtanMucmF3RGVjb2RlKFtcInN0cmluZ1wiXSwgQnVmZmVyLmZyb20ocmVzdWx0LCBcImhleFwiKSk7XG4gICAgaWYgKGRhdGEubGVuZ3RoID4gMCkge1xuICAgICAgcmV0dXJuIGRhdGFbMF07XG4gICAgfVxuICAgIHJldHVybiBcIlwiO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHN5bWJvbChjYWxsZXJBZGRyZXNzOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVhZE1ldGhvZChcInN5bWJvbFwiLCBjYWxsZXJBZGRyZXNzKTtcbiAgICBjb25zdCBkYXRhID0gZXRoZXJldW1qcy5yYXdEZWNvZGUoW1wic3RyaW5nXCJdLCBCdWZmZXIuZnJvbShyZXN1bHQsIFwiaGV4XCIpKTtcbiAgICBpZiAoZGF0YS5sZW5ndGggPiAwKSB7XG4gICAgICByZXR1cm4gZGF0YVswXTtcbiAgICB9XG4gICAgcmV0dXJuIFwiXCI7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVjaW1hbHMoY2FsbGVyQWRkcmVzczogc3RyaW5nKTogUHJvbWlzZTxCaWdOdW1iZXI+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnJlYWRNZXRob2QoXCJkZWNpbWFsc1wiLCBjYWxsZXJBZGRyZXNzKTtcbiAgICByZXR1cm4gbmV3IEJpZ051bWJlcihyZXN1bHQsIDE2KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB0b3RhbFN1cHBseShjYWxsZXJBZGRyZXNzOiBzdHJpbmcpOiBQcm9taXNlPEJpZ051bWJlcj4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVhZE1ldGhvZChcInRvdGFsU3VwcGx5XCIsIGNhbGxlckFkZHJlc3MpO1xuICAgIHJldHVybiBuZXcgQmlnTnVtYmVyKHJlc3VsdCwgMTYpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGJhbGFuY2VPZihcbiAgICBvd25lcjogc3RyaW5nLFxuICAgIGNhbGxlckFkZHJlc3M6IHN0cmluZ1xuICApOiBQcm9taXNlPEJpZ051bWJlcj4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucmVhZE1ldGhvZChcImJhbGFuY2VPZlwiLCBjYWxsZXJBZGRyZXNzLCBvd25lcik7XG4gICAgcmV0dXJuIG5ldyBCaWdOdW1iZXIocmVzdWx0LCAxNik7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdHJhbnNmZXIoXG4gICAgdG86IHN0cmluZyxcbiAgICB2YWx1ZTogQmlnTnVtYmVyLFxuICAgIGFjY291bnQ6IEFjY291bnQsXG4gICAgZ2FzUHJpY2U6IHN0cmluZyxcbiAgICBnYXNMaW1pdDogc3RyaW5nXG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuZXhlY3V0ZU1ldGhvZChcbiAgICAgIFwidHJhbnNmZXJcIixcbiAgICAgIGFjY291bnQsXG4gICAgICBnYXNQcmljZSxcbiAgICAgIGdhc0xpbWl0LFxuICAgICAgXCIwXCIsXG4gICAgICB0byxcbiAgICAgIHZhbHVlLnRvRml4ZWQoMClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGFsbG93YW5jZShcbiAgICBvd25lcjogc3RyaW5nLFxuICAgIHNwZW5kZXI6IHN0cmluZyxcbiAgICBhY2NvdW50OiBBY2NvdW50LFxuICAgIGdhc1ByaWNlOiBzdHJpbmcsXG4gICAgZ2FzTGltaXQ6IHN0cmluZ1xuICApOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmV4ZWN1dGVNZXRob2QoXG4gICAgICBcImFsbG93YW5jZVwiLFxuICAgICAgYWNjb3VudCxcbiAgICAgIGdhc1ByaWNlLFxuICAgICAgZ2FzTGltaXQsXG4gICAgICBcIjBcIixcbiAgICAgIG93bmVyLFxuICAgICAgc3BlbmRlclxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgYXBwcm92ZShcbiAgICBzcGVuZGVyOiBzdHJpbmcsXG4gICAgdmFsdWU6IEJpZ051bWJlcixcbiAgICBhY2NvdW50OiBBY2NvdW50LFxuICAgIGdhc1ByaWNlOiBzdHJpbmcsXG4gICAgZ2FzTGltaXQ6IHN0cmluZ1xuICApOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmV4ZWN1dGVNZXRob2QoXG4gICAgICBcImFwcHJvdmVcIixcbiAgICAgIGFjY291bnQsXG4gICAgICBnYXNQcmljZSxcbiAgICAgIGdhc0xpbWl0LFxuICAgICAgXCIwXCIsXG4gICAgICBzcGVuZGVyLFxuICAgICAgdmFsdWUudG9GaXhlZCgwKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdHJhbnNmZXJGcm9tKFxuICAgIGZyb206IHN0cmluZyxcbiAgICB0bzogc3RyaW5nLFxuICAgIHZhbHVlOiBCaWdOdW1iZXIsXG4gICAgYWNjb3VudDogQWNjb3VudCxcbiAgICBnYXNQcmljZTogc3RyaW5nLFxuICAgIGdhc0xpbWl0OiBzdHJpbmdcbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gdGhpcy5leGVjdXRlTWV0aG9kKFxuICAgICAgXCJ0cmFuc2ZlckZyb21cIixcbiAgICAgIGFjY291bnQsXG4gICAgICBnYXNQcmljZSxcbiAgICAgIGdhc0xpbWl0LFxuICAgICAgXCIwXCIsXG4gICAgICBmcm9tLFxuICAgICAgdG8sXG4gICAgICB2YWx1ZS50b0ZpeGVkKDApXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcmVhZE1ldGhvZChcbiAgICBtZXRob2Q6IHN0cmluZyxcbiAgICBjYWxsZXJBZGRyZXNzOiBzdHJpbmcsXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogdHlwZWRlZlxuICAgIC4uLmFyZ3NcbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnByb3ZpZGVyLnJlYWRDb250cmFjdCh7XG4gICAgICBleGVjdXRpb246IHRoaXMuY29udHJhY3QucHVyZUVuY29kZU1ldGhvZChcIjBcIiwgbWV0aG9kLCAuLi5hcmdzKSxcbiAgICAgIGNhbGxlckFkZHJlc3M6IGNhbGxlckFkZHJlc3NcbiAgICB9KTtcblxuICAgIHJldHVybiByZXN1bHQuZGF0YTtcbiAgfVxuXG4gIHByaXZhdGUgZXhlY3V0ZU1ldGhvZChcbiAgICBtZXRob2Q6IHN0cmluZyxcbiAgICBhY2NvdW50OiBBY2NvdW50LFxuICAgIGdhc1ByaWNlOiBzdHJpbmcsXG4gICAgZ2FzTGltaXQ6IHN0cmluZyxcbiAgICBhbW91bnQ6IHN0cmluZyxcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiB0eXBlZGVmXG4gICAgLi4uYXJnc1xuICApOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmNvbnRyYWN0Lm1ldGhvZHNbbWV0aG9kXSguLi5hcmdzLCB7XG4gICAgICBhY2NvdW50OiBhY2NvdW50LFxuICAgICAgYW1vdW50OiBhbW91bnQsXG4gICAgICBnYXNMaW1pdDogZ2FzTGltaXQsXG4gICAgICBnYXNQcmljZTogZ2FzUHJpY2VcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBkZWNvZGUoZGF0YTogc3RyaW5nKTogRGVjb2RlRGF0YSB7XG4gICAgaWYgKGRhdGEubGVuZ3RoIDwgOCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaW5wdXQgZGF0YSBlcnJvclwiKTtcbiAgICB9XG4gICAgY29uc3QgbWV0aG9kS2V5ID0gZGF0YS5zdWJzdHIoMCwgOCk7XG4gICAgY29uc3QgbWV0aG9kID0gdGhpcy5tZXRob2RzW21ldGhvZEtleV07XG4gICAgaWYgKCFtZXRob2QpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgbWV0aG9kICR7bWV0aG9kS2V5fSBpcyBub3QgZXJjMjAgbWV0aG9kYCk7XG4gICAgfVxuICAgIGNvbnN0IHBhcmFtcyA9IGV0aGVyZXVtanMucmF3RGVjb2RlKFxuICAgICAgbWV0aG9kLmlucHV0c1R5cGVzLFxuICAgICAgQnVmZmVyLmZyb20oZGF0YS5zdWJzdHJpbmcoOCksIFwiaGV4XCIpXG4gICAgKTtcbiAgICBjb25zdCB2YWx1ZXMgPSB7fTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWV0aG9kLmlucHV0c1R5cGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAobWV0aG9kLmlucHV0c1R5cGVzW2ldID09PSBcImFkZHJlc3NcIikge1xuICAgICAgICBwYXJhbXNbaV0gPSBmcm9tQnl0ZXMoXG4gICAgICAgICAgQnVmZmVyLmZyb20ocGFyYW1zW2ldLnRvU3RyaW5nKCksIFwiaGV4XCIpXG4gICAgICAgICkuc3RyaW5nKCk7XG4gICAgICB9XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICB2YWx1ZXNbbWV0aG9kLmlucHV0c05hbWVzW2ldXSA9IHBhcmFtc1tpXTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgbWV0aG9kOiBtZXRob2QubmFtZSxcbiAgICAgIGRhdGE6IHZhbHVlc1xuICAgIH07XG4gIH1cbn1cbiJdfQ==